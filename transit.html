<html><head><link rel="shortcut icon"href="img/favicon.ico"><link rel="apple-touch-icon"href="img/apple-touch-icon.png"><link rel="icon"type="image/png"href="img/android-chrome-192x192.png"><meta charset="UTF-8"><meta name="viewport"content="initial-scale=1"><style>:root{--text:#333;--text-link:#1558d6;--text-link-active:#0f3f99;--background:#fff;--border:#ccc;--shadow:rgba(63,63,63,0.2);}@media(prefers-color-scheme:dark){:root{--text:#ccc;--text-link:#8ab4f8;--text-link-active:#6382b3;--background:#111;--border:#444;--shadow:rgba(192,192,192,0.2);}}*{box-sizing:border-box;margin:0;padding:0;position:relative;}body{background-color:var(--background);color:var(--text);font-family:Helvetica,sans-serif;display:flex;flex-direction:column;align-items:center;padding:10px;padding-bottom:calc(3em + 20px);}a{color:var(--text-link);}a:active{color:var(--text-link-active);}select,button{margin:0.25em;background-color:var(--background);border:1px solid var(--border);border-radius:5px;color:var(--text);font-size:1em;padding:0.4em;}button{background-color:var(--border);padding:0.4em 2em;}#content{width:min(100%,400px);}#add-button{width:min(100%,400px);height:3em;border:1px solid var(--border);border-radius:5px;font-weight:bold;display:grid;place-items:center;}#toast{position:fixed;bottom:0;width:min(calc(100% - 20px),400px);height:3em;margin:10px;background-color:var(--background);border-radius:5px;box-shadow:0 0 5px var(--shadow);transition:transform 0.2s ease-in-out;display:grid;place-items:center;}#toast.hidden{transform:translateY(5em);}.timetable{width:min(100%,400px);margin-bottom:10px;}.timetable-title{background-color:var(--border);border-radius:5px 5px 0 0;font-weight:bold;padding:0.25em 0.5em;}.timetable-table{height:12.5em;border:1px solid var(--border);border-radius:0 0 5px 5px;border-top:none;overflow-y:auto;padding:0.25em;}.timetable-item{border-top:1px solid var(--border);display:flex;align-items:center;padding:0.25em;}.timetable-item:first-child{border-top:none;}.timetable-item.gone{color:var(--border);}.modal-bg{position:fixed;left:0;top:0;width:100%;height:100vh;background-color:rgba(0,0,0,0.75);display:grid;place-items:center;padding:100px 20px;}.modal{background-color:var(--background);border-radius:5px;box-shadow:0 0 5px var(--shadow);padding:10px;display:flex;flex-direction:column;align-items:center;}.button{cursor:pointer;user-select:none;-webkit-user-select:none;}.button:active{background-color:var(--shadow);}.display-none{display:none!important;}</style></head><body ontouchstart><div id="content"></div><div id="add-button"class="display-none button">＋ 追加</div><div id="toast"class="hidden"></div><script>onload=async()=>{const content=document.getElementById("content");const addButton=document.getElementById("add-button");const toast=document.getElementById("toast");const GAS_API_URL="https://script.google.com/macros/s/AKfycbwafFs2y7IvfL2OkU_-Z7PfQJGwfYjxxptibbApEtGJjL5BFDPVqAUhKxvXUJ7stle_mw/exec";const tableList=JSON.parse(localStorage.getItem("tableList"))||[{depName:"八木山神社前",arrName:"青葉山",},{depName:"青葉山",arrName:"八木山神社前",},{depName:"八木山神社前",arrName:"工学部中央",},{depName:"工学部中央",arrName:"八木山神社前",},];const main=nodeList=>{const createModal=()=>{const modalBg=document.createElement("div");modalBg.classList.add("modal-bg");modalBg.onclick=e=>{if(e.target===modalBg)modalBg.remove();};document.body.append(modalBg);const modal=document.createElement("div");modal.classList.add("modal");modal.close=()=>{modalBg.remove();};modalBg.append(modal);return modal;};const addTable=(nodeList,table)=>{const strTime=(time,type)=>{const h=Math.floor(time/60);const m=time%60;if(type==="interval"){if(h>0)return`${h}時間${m}分`;else return`${m}分`;}else{return("0"+h).slice(-2)+":"+("0"+m).slice(-2);}};const seekRoutes=(nodeList,depName,arrName)=>{const routes=[];const depNode=nodeList.find(node=>node.name===depName);const arrNode=nodeList.find(node=>node.name===arrName);const rec=(depNode,route=[])=>{if(depNode===arrNode){routes.push([...route,{...arrNode}]);return;}depNode.nodes.forEach(adjNode=>{if(route.some(node=>node.name===adjNode.name))return;adjNode.edges.forEach(edge=>{if(edge.name!=="徒歩"&&route.some(node=>node.edge.name===edge.name))return;const new_depNode=nodeList.find(node=>node.name===adjNode.name);const new_route=[...route,{...depNode,edge}];rec(new_depNode,new_route);});});};rec(depNode);return routes;};const routeToSeqList=(route,margin=0)=>{const firstTimedIndex=route.findIndex(node=>node.edge?.depArrTimeList);if(firstTimedIndex===-1)return[];const seqList=route[firstTimedIndex].edge.depArrTimeList.map(([depTime,arrTime])=>route.map((node,i)=>(i===firstTimedIndex?{...node,depTime}:i===firstTimedIndex+1?{...node,arrTime}:{...node})));seqList.forEach(seq=>{for(let i=firstTimedIndex-1;i>=0;i--){seq[i].depTime=seq[i+1].depTime-(seq[i].edge.duration+margin);seq[i+1].arrTime=seq[i+1].depTime;}for(let i=firstTimedIndex+1;i<seq.length-1;i++){if(seq[i].edge.name==="徒歩"){seq[i].depTime=seq[i].arrTime;seq[i+1].arrTime=seq[i].arrTime+(seq[i].edge.duration+margin);}else{const depArrTime=seq[i].edge.depArrTimeList.find(([depTime,_])=>seq[i].arrTime+margin<=depTime);if(!depArrTime)return;[seq[i].depTime,seq[i+1].arrTime]=depArrTime;}}});return seqList.filter(seq=>seq.slice(-1)[0].arrTime!==undefined);};const{depName,arrName}=table;const routes=seekRoutes(nodeList,depName,arrName);const allSeqList=routes.map(route=>routeToSeqList(route)).flat().filter((seq,_,allSeqList)=>!allSeqList.some(seq2=>(seq[0].depTime<=seq2[0].depTime&&seq.slice(-1)[0].arrTime>=seq2.slice(-1)[0].arrTime&&!(seq[0].depTime===seq2[0].depTime&&seq.slice(-1)[0].arrTime===seq2.slice(-1)[0].arrTime)))).sort((seq1,seq2)=>seq1[0].depTime-seq2[0].depTime);const div=document.createElement("div");div.classList.add("timetable");div.append((()=>{const div=document.createElement("div");div.classList.add("timetable-title");div.textContent=depName+" ⇒ "+arrName;return div;})(),(()=>{const div=document.createElement("div");div.classList.add("timetable-table");if(!allSeqList.length){div.style=`display:grid;place-items:center;`;div.textContent="ルートが見つかりません";return div;}div.append(...allSeqList.map(seq=>{const div=document.createElement("div");div.classList.add("timetable-item","button");div.append((()=>{const div=document.createElement("div");div.style=`white-space:nowrap;`;div.innerHTML=`${strTime(seq[0].depTime).big().big().bold()}発→${strTime(seq.slice(-1)[0].arrTime).big().big().bold()}着(${strTime(seq.slice(-1)[0].arrTime-seq[0].depTime,"interval")})`;return div;})(),(()=>{const div=document.createElement("div");div.style=`padding-left:0.5em;line-height:0.8em;`;div.innerHTML=seq.filter(node=>node.edge).map(node=>node.edge.shortName||node.edge.name).join(", ").small().small();return div;})(),);div.onclick=()=>{const modal=createModal();modal.append((()=>{const div=document.createElement("div");div.style.marginBottom="5px";div.innerHTML=`${strTime(seq[0].depTime).big().big().bold()}発→${strTime(seq.slice(-1)[0].arrTime).big().big().bold()}着(${strTime(seq.slice(-1)[0].arrTime-seq[0].depTime,"interval")})`;return div;})());seq.forEach((node,index)=>{modal.append((()=>{const div=document.createElement("div");div.style=`width:100%;display:flex;align-items:center;`;div.append((()=>{const div=document.createElement("div");div.style=`line-height:1em;white-space:nowrap;`;div.innerHTML=[...(node.arrTime?[strTime(node.arrTime)+"着"]:[]),...(node.depTime?[strTime(node.depTime)+"発"]:[]),].join("<br>").small();return div;})(),(()=>{const div=document.createElement("div");div.style=`margin-left:0.5em;white-space:nowrap;`;div.innerHTML=node.name.bold();return div;})(),);if(node.dokobus)div.append((()=>{const div=document.createElement("div");div.style=`margin-left:0.5em;border:1px solid var(--border);border-radius:5px;font-size:0.8em;padding:0 0.4em;`;div.classList.add("button");div.textContent="接近情報";div.onclick=()=>{const modal=createModal();modal.append((()=>{const div=document.createElement("div");div.style.marginBottom="5px";div.innerHTML=`<b>${node.name}</b>の接近情報`;return div;})(),(()=>{const div=document.createElement("div");div.append(...node.dokobus.map(link=>{const a=document.createElement("a");a.style=`display:block;`;a.href=link.url;a.target="_blank";a.rel="noopener noreferrer";a.innerHTML=link.name+'<svg xmlns="http://www.w3.org/2000/svg" width="12" height="15" viewBox="0 0 24 30" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>';return a;}));return div;})());};return div;})());return div;})());if(node.edge)modal.append((()=>{const div=document.createElement("div");div.style=`width:100%;margin-left:2em;border-left:2px solid var(--border);padding:0.5em;display:flex;align-items:center;`;div.append((()=>{const div=document.createElement("div");div.style=`white-space:nowrap;`;div.innerHTML=strTime(seq[index+1].arrTime-node.depTime,"interval").small();return div;})(),(()=>{const div=document.createElement("div");div.style.marginLeft="0.5em";div.append((()=>{const span=document.createElement("span");span.textContent=node.edge.name;return span;})());if(node.edge.url)div.append((()=>{const a=document.createElement("a");a.style.marginLeft="0.5em";a.href=node.edge.url;a.target="_blank";a.rel="noopener noreferrer";a.innerHTML='時刻表<svg xmlns="http://www.w3.org/2000/svg" width="12" height="15" viewBox="0 0 24 30" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>';return a;})());return div;})(),);return div;})());});};return div;}));let prevIndex;const refreshState=()=>{const date=new Date();const currentTime=60*date.getHours()+date.getMinutes();const nextIndex=allSeqList.findIndex(seq=>seq[0].depTime>=currentTime);if(nextIndex!==prevIndex){Array.from(div.children).forEach((div,i)=>{if(i<nextIndex||nextIndex===-1){div.classList.add("gone");}});if(nextIndex!==-1)div.scrollTo({top:div.children[nextIndex].offsetTop-(div.offsetHeight-div.children[nextIndex].offsetHeight)/2,behavior:"smooth",});prevIndex=nextIndex;}};setTimeout(refreshState,0);setInterval(refreshState,1000);return div;})(),(()=>{const delIcon=document.createElement("div");delIcon.style=`position:absolute;right:8px;top:-5px;font-size:2em;`;delIcon.classList.add("button");delIcon.textContent="×";delIcon.onclick=()=>{if(confirm(`"${depName}⇒${arrName}"\nを削除しますか？`)){div.remove();tableList.splice(tableList.indexOf(table),1);localStorage.setItem("tableList",JSON.stringify(tableList));}};return delIcon;})());content.append(div);};while(content.firstChild)content.firstChild.remove();tableList.forEach(table=>{addTable(nodeList,table);});addButton.classList.remove("display-none");addButton.onclick=()=>{const modal=createModal();const[depSelect,arrSelect]=["出発地：","目的地："].map((text,index)=>{const div=document.createElement("div");const span=document.createElement("span");span.textContent=text;const select=document.createElement("select");select.append(...nodeList.map(node=>{const option=document.createElement("option");option.textContent=node.name;return option;}));select.selectedIndex=index;div.append(span,select);modal.append(div);return select;});let depName,arrName;const onchange=()=>{if(depSelect.value===arrSelect.value){[depSelect.value,arrSelect.value]=[arrName,depName];[depName,arrName]=[arrName,depName];}else{[depName,arrName]=[depSelect.value,arrSelect.value];}};onchange();depSelect.onchange=onchange;arrSelect.onchange=onchange;const button=document.createElement("button");button.classList.add("button");button.style.marginTop="10px";button.textContent="追加";button.onclick=()=>{const table={depName,arrName};tableList.push(table);localStorage.setItem("tableList",JSON.stringify(tableList));modal.close();addTable(nodeList,table);};modal.append(button);};};const date=(()=>{const date=new Date();if(date.getHours()<4)date.setDate(date.getDate()-1);return date;})();const day=date.getDay();const strDate=date.toLocaleDateString();const isHoliday=shukujitsu=>shukujitsu&&shukujitsu.data.find(row=>row[0]===strDate)?.[1];const shukujitsu=JSON.parse(localStorage.getItem("shukujitsu")||"null");const nodeList=JSON.parse(localStorage.getItem(date.getDay()===0||isHoliday(shukujitsu)?"nodeList_holiday":date.getDay()===6?"nodeList_saturday":"nodeList_weekday")||"null");if(nodeList)main(nodeList.data);if(localStorage.getItem("lastUpdate")!==strDate){toast.classList.remove("hidden");toast.textContent="祝日データ取得中...";const shukujitsu_fetched=await(await fetch(GAS_API_URL+"?type=shukujitsu"+"&hash="+(shukujitsu?shukujitsu.hash:""))).json();if(shukujitsu_fetched)localStorage.setItem("shukujitsu",JSON.stringify(shukujitsu_fetched));toast.textContent="時刻表データ取得中...";const nodeList_fetched=await(await fetch(GAS_API_URL+"?type=nodeList"+"&hash="+(nodeList?nodeList.hash:""))).json();if(nodeList_fetched)localStorage.setItem(day===0||isHoliday(shukujitsu_fetched||shukujitsu)?"nodeList_holiday":day===6?"nodeList_saturday":"nodeList_weekday",JSON.stringify(nodeList_fetched));setInterval(()=>toast.classList.add("hidden"),3000);localStorage.setItem("lastUpdate",strDate);if(nodeList_fetched||shukujitsu_fetched){toast.textContent=[...(shukujitsu_fetched?["祝日データ"]:[]),...(nodeList_fetched?["時刻表データ"+(day===0||isHoliday(shukujitsu_fetched||shukujitsu)?"(休日)":day===6?"(土曜)":"(平日)")]:[]),].join(", ")+"を更新しました";main(nodeList_fetched.data);}else toast.textContent="更新なし";}};</script></body></html>