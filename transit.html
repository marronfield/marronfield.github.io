<html><head><link rel="shortcut icon"href="img/favicon.ico"><link rel="apple-touch-icon"href="img/apple-touch-icon.png"><link rel="icon"type="image/png"href="img/android-chrome-192x192.png"><meta charset="UTF-8"><meta name="viewport"content="initial-scale=1"><style>:root{--text:#333;--text-link:#1558d6;--text-link-active:#0f3f99;--background:#fff;--border:#ccc;--shadow:rgba(63,63,63,0.2);}@media(prefers-color-scheme:dark){:root{--text:#ccc;--text-link:#8ab4f8;--text-link-active:#6382b3;--background:#111;--border:#444;--shadow:rgba(192,192,192,0.2);}}*{box-sizing:border-box;margin:0;padding:0;position:relative;touch-action:manipulation;}body{min-height:100vh;background-color:var(--background);color:var(--text);font-family:Helvetica,sans-serif;display:flex;flex-direction:column;align-items:center;padding:10px;padding-bottom:calc(3em + 20px);}a{color:var(--text-link);}a:active{color:var(--text-link-active);}select,button{margin:0.25em;background-color:var(--background);border:1px solid var(--border);border-radius:5px;color:var(--text);font-size:1em;padding:0.4em;}button{background-color:var(--border);padding:0.4em 2em;}#header{width:min(100%,400px);margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;}#setting-button{border-radius:5px;display:grid;place-items:center;padding:5px;}#content{width:min(100%,400px);}#add-button{width:min(100%,400px);height:3em;border:1px solid var(--border);border-radius:5px;font-weight:bold;display:grid;place-items:center;}#toast{position:fixed;bottom:0;width:min(calc(100% - 20px),400px);height:3em;margin:10px;background-color:var(--background);border-radius:5px;box-shadow:0 0 5px var(--shadow);transition:transform 0.2s ease-in-out;display:grid;place-items:center;}#toast.hidden{transform:translateY(5em);}.timetable{width:min(100%,400px);margin-bottom:10px;}.timetable-title{background-color:var(--border);border-radius:5px 5px 0 0;font-weight:bold;padding:0.25em 0.5em;}.timetable-table{height:12.5em;border:1px solid var(--border);border-radius:0 0 5px 5px;border-top:none;overflow-y:auto;padding:0.25em;}.timetable-item{border-top:1px solid var(--border);display:flex;align-items:center;padding:0.25em;}.timetable-item:first-child{border-top:none;}.timetable-item.done{color:var(--border);}.timetable-del-button{position:absolute;right:7px;top:7px;}.modal-bg{position:fixed;left:0;top:0;width:100%;height:100vh;background-color:rgba(0,0,0,0.75);display:grid;place-items:center;padding:100px 20px;}.modal{background-color:var(--background);border-radius:5px;box-shadow:0 0 5px var(--shadow);padding:10px;display:flex;flex-direction:column;align-items:center;}.button{cursor:pointer;user-select:none;-webkit-user-select:none;}.button:active{background-color:var(--shadow);}.display-none{display:none!important;}</style></head><body ontouchstart><div id="header"><select id="daytype-selector"><option>平日ダイヤ</option><option>土曜ダイヤ</option><option>休日ダイヤ</option></select><div id="setting-button"class="button"><svg xmlns="http://www.w3.org/2000/svg"width="20"height="20"viewBox="0 0 512 512"fill="currentColor"><path d="M256,176a80,80,0,1,0,80,80A80.24,80.24,0,0,0,256,176Zm172.72,80a165.53,165.53,0,0,1-1.64,22.34l48.69,38.12a11.59,11.59,0,0,1,2.63,14.78l-46.06,79.52a11.64,11.64,0,0,1-14.14,4.93l-57.25-23a176.56,176.56,0,0,1-38.82,22.67l-8.56,60.78A11.93,11.93,0,0,1,302.06,486H209.94a12,12,0,0,1-11.51-9.53l-8.56-60.78A169.3,169.3,0,0,1,151.05,393L93.8,416a11.64,11.64,0,0,1-14.14-4.92L33.6,331.57a11.59,11.59,0,0,1,2.63-14.78l48.69-38.12A174.58,174.58,0,0,1,83.28,256a165.53,165.53,0,0,1,1.64-22.34L36.23,195.54a11.59,11.59,0,0,1-2.63-14.78l46.06-79.52A11.64,11.64,0,0,1,93.8,96.31l57.25,23a176.56,176.56,0,0,1,38.82-22.67l8.56-60.78A11.93,11.93,0,0,1,209.94,26h92.12a12,12,0,0,1,11.51,9.53l8.56,60.78A169.3,169.3,0,0,1,361,119L418.2,96a11.64,11.64,0,0,1,14.14,4.92l46.06,79.52a11.59,11.59,0,0,1-2.63,14.78l-48.69,38.12A174.58,174.58,0,0,1,428.72,256Z"/></svg></div></div><div id="content"></div><div id="add-button"class="display-none button">＋ 追加</div><div id="toast"class="hidden"></div><script>onload=async()=>{const createModal=()=>{const modalBg=document.createElement("div");modalBg.classList.add("modal-bg");modalBg.onclick=e=>{if(e.target===modalBg)modalBg.remove();};document.body.append(modalBg);const modal=document.createElement("div");modal.classList.add("modal");modal.close=()=>{modalBg.remove();};modalBg.append(modal);return modal;};const content=document.getElementById("content");const addButton=document.getElementById("add-button");const settingButton=document.getElementById("setting-button");const toast=document.getElementById("toast");const svgIcons={extlink:'<svg xmlns="http://www.w3.org/2000/svg" width="12" height="15" viewBox="0 0 24 30" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>',delete:'<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="2" y1="2" x2="16" y2="16"></line><line x1="2" y1="16" x2="16" y2="2"></line></svg>',};const tableList=JSON.parse(localStorage.getItem("tableList"))||[{depName:"八木山神社前",arrName:"青葉山",},{depName:"青葉山",arrName:"八木山神社前",},{depName:"八木山神社前",arrName:"工学部中央",},{depName:"工学部中央",arrName:"八木山神社前",},];const settings=JSON.parse(localStorage.getItem("settings"))||{margin:0,update_shukujitsu:"毎日",update_nodeList:"毎日",};const displayTables=nodeList=>{const addTable=(nodeList,table,margin)=>{const strTime=(time,type)=>{const h=Math.floor(time/60);const m=time%60;if(type==="interval"){if(h>0)return`${h}時間${m}分`;else return`${m}分`;}else{return("0"+h).slice(-2)+":"+("0"+m).slice(-2);}};const seekRoutes=(nodeList,depName,arrName)=>{const depNode=nodeList.find(node=>node.name===depName);const arrNode=nodeList.find(node=>node.name===arrName);if(!depNode||!arrNode)return[];const routes=[];const rec=(depNode,route=[])=>{if(depNode===arrNode){routes.push([...route,{...arrNode}]);return;}depNode.nodes.forEach(adjNode=>{if(route.some(node=>node.name===adjNode.name))return;adjNode.edges.forEach(edge=>{if(edge.name!=="徒歩"&&route.some(node=>node.edge.name===edge.name))return;const new_depNode=nodeList.find(node=>node.name===adjNode.name);const new_route=[...route,{...depNode,edge}];rec(new_depNode,new_route);});});};rec(depNode);return routes;};const routeToSeqList=(route,margin)=>{const firstTimedIndex=route.findIndex(node=>node.edge?.depArrTimeList);if(firstTimedIndex===-1)return[];const seqList=route[firstTimedIndex].edge.depArrTimeList.map(([depTime,arrTime])=>route.map((node,i)=>(i===firstTimedIndex?{...node,depTime}:i===firstTimedIndex+1?{...node,arrTime}:{...node})));seqList.forEach(seq=>{for(let i=firstTimedIndex-1;i>=0;i--){seq[i].depTime=seq[i+1].depTime-(seq[i].edge.duration+margin);seq[i+1].arrTime=seq[i+1].depTime;}for(let i=firstTimedIndex+1;i<seq.length-1;i++){if(seq[i].edge.name==="徒歩"){seq[i].depTime=seq[i].arrTime;seq[i+1].arrTime=seq[i].arrTime+(seq[i].edge.duration+margin);}else{const depArrTime=seq[i].edge.depArrTimeList.find(([depTime,_])=>seq[i].arrTime+margin<=depTime);if(!depArrTime)return;[seq[i].depTime,seq[i+1].arrTime]=depArrTime;}}});return seqList.filter(seq=>seq.slice(-1)[0].arrTime!==undefined);};const{depName,arrName}=table;const routes=seekRoutes(nodeList,depName,arrName);const allSeqList=routes.map(route=>routeToSeqList(route,margin)).flat().filter((seq,_,allSeqList)=>!allSeqList.some(seq2=>(seq[0].depTime<=seq2[0].depTime&&seq.slice(-1)[0].arrTime>=seq2.slice(-1)[0].arrTime&&!(seq[0].depTime===seq2[0].depTime&&seq.slice(-1)[0].arrTime===seq2.slice(-1)[0].arrTime)))).sort((seq1,seq2)=>seq1[0].depTime-seq2[0].depTime);const div=document.createElement("div");div.classList.add("timetable");div.append((()=>{const div=document.createElement("div");div.classList.add("timetable-title");div.textContent=depName+" ⇒ "+arrName;return div;})(),(()=>{const div=document.createElement("div");div.classList.add("timetable-table");if(!allSeqList.length){div.style=`display:grid;place-items:center;`;div.textContent="ルートが見つかりません";return div;}div.append(...allSeqList.map(seq=>{const div=document.createElement("div");div.classList.add("timetable-item","button");div.append((()=>{const div=document.createElement("div");div.style=`white-space:nowrap;`;div.innerHTML=`${strTime(seq[0].depTime).big().big().bold()}発→${strTime(seq.slice(-1)[0].arrTime).big().big().bold()}着(${strTime(seq.slice(-1)[0].arrTime-seq[0].depTime,"interval")})`;return div;})(),(()=>{const div=document.createElement("div");div.style=`padding-left:0.5em;line-height:0.8em;`;div.innerHTML=seq.filter(node=>node.edge).map(node=>node.edge.shortName||node.edge.name).join(", ").small().small();return div;})(),);div.onclick=()=>{const modal=createModal();modal.append((()=>{const div=document.createElement("div");div.style.marginBottom="5px";div.innerHTML=`${strTime(seq[0].depTime).big().big().bold()}発→${strTime(seq.slice(-1)[0].arrTime).big().big().bold()}着(${strTime(seq.slice(-1)[0].arrTime-seq[0].depTime,"interval")})`;return div;})());seq.forEach((node,index)=>{modal.append((()=>{const div=document.createElement("div");div.style=`width:100%;display:flex;align-items:center;`;div.append((()=>{const div=document.createElement("div");div.style=`line-height:1em;white-space:nowrap;`;div.innerHTML=[...(node.arrTime?[strTime(node.arrTime)+"着"]:[]),...(node.depTime?[strTime(node.depTime)+"発"]:[]),].join("<br>").small();return div;})(),(()=>{const div=document.createElement("div");div.style=`margin-left:0.5em;white-space:nowrap;`;div.innerHTML=node.name.bold();return div;})(),);if(node.dokobus)div.append((()=>{const div=document.createElement("div");div.style=`margin-left:0.5em;border:1px solid var(--border);border-radius:5px;font-size:0.8em;padding:0 0.4em;`;div.classList.add("button");div.textContent="接近情報";div.onclick=()=>{const modal=createModal();modal.append((()=>{const div=document.createElement("div");div.style.marginBottom="5px";div.innerHTML=`<b>${node.name}</b>の接近情報`;return div;})(),(()=>{const div=document.createElement("div");div.append(...node.dokobus.map(link=>{const a=document.createElement("a");a.style=`display:block;`;a.href=link.url;a.target="_blank";a.rel="noopener noreferrer";a.innerHTML=link.name+svgIcons.extlink;return a;}));return div;})());};return div;})());return div;})());if(node.edge)modal.append((()=>{const div=document.createElement("div");div.style=`width:100%;margin-left:2em;border-left:2px solid var(--border);padding:0.5em;display:flex;align-items:center;`;div.append((()=>{const div=document.createElement("div");div.style=`white-space:nowrap;`;div.innerHTML=strTime(seq[index+1].arrTime-node.depTime,"interval").small();return div;})(),(()=>{const div=document.createElement("div");div.style.marginLeft="0.5em";div.append((()=>{const span=document.createElement("span");span.textContent=node.edge.name;return span;})());if(node.edge.url)div.append((()=>{const a=document.createElement("a");a.style.marginLeft="0.5em";a.href=node.edge.url;a.target="_blank";a.rel="noopener noreferrer";a.innerHTML="時刻表"+svgIcons.extlink;return a;})());return div;})(),);return div;})());});};return div;}));let prevIndex;const refreshState=()=>{const currentTime=(()=>{const date=new Date();const h=date.getHours();const m=date.getMinutes();return 60*(h<4?h+24:h)+m;})();const nextIndex=allSeqList.findIndex(seq=>seq[0].depTime>=currentTime);if(nextIndex!==prevIndex){Array.from(div.children).forEach((div,i)=>{if(i<nextIndex||nextIndex===-1){div.classList.add("done");}});if(nextIndex!==-1)div.scrollTo({top:div.children[nextIndex].offsetTop-(div.offsetHeight-div.children[nextIndex].offsetHeight)/2,behavior:"smooth",});prevIndex=nextIndex;}};setTimeout(refreshState,0);setInterval(refreshState,1000);return div;})(),(()=>{const delButton=document.createElement("div");delButton.classList.add("timetable-del-button","button");delButton.innerHTML=svgIcons.delete;delButton.onclick=()=>{if(confirm(`"${depName} ⇒ ${arrName}"\nを削除しますか？`)){div.remove();tableList.splice(tableList.indexOf(table),1);localStorage.setItem("tableList",JSON.stringify(tableList));}};return delButton;})());content.append(div);return div;};while(content.firstChild)content.firstChild.remove();if(!nodeList||!nodeList.length){content.append((()=>{const div=document.createElement("div");div.style=`text-align:center;`;div.textContent="データがありません";return div;})());addButton.classList.add("display-none");return;}tableList.forEach(table=>{addTable(nodeList,table,settings.margin);});addButton.classList.remove("display-none");addButton.onclick=()=>{const modal=createModal();const[depSelect,arrSelect]=["出発地：","目的地："].map((text,index)=>{const div=document.createElement("div");const span=document.createElement("span");span.textContent=text;const select=document.createElement("select");select.append(...nodeList.map(node=>{const option=document.createElement("option");option.textContent=node.name;return option;}));select.selectedIndex=index;div.append(span,select);modal.append(div);return select;});let depName,arrName;const onchange=()=>{if(depSelect.value===arrSelect.value){[depSelect.value,arrSelect.value]=[arrName,depName];[depName,arrName]=[arrName,depName];}else{[depName,arrName]=[depSelect.value,arrSelect.value];}};onchange();depSelect.onchange=onchange;arrSelect.onchange=onchange;const button=document.createElement("button");button.classList.add("button");button.style.marginTop="10px";button.textContent="追加";button.onclick=()=>{const table={depName,arrName};tableList.push(table);localStorage.setItem("tableList",JSON.stringify(tableList));modal.close();const div=addTable(nodeList,table);window.scrollTo({top:div.offsetTop,behavior:"smooth",});};modal.append(button);};};const getNodeList=daytype=>JSON.parse(localStorage.getItem("nodeList_"+daytype));const date=(()=>{const date=new Date();if(date.getHours()<4)date.setDate(date.getDate()-1);return date;})();const strDate=date.toLocaleDateString();const shukujitsu=JSON.parse(localStorage.getItem("shukujitsu"))||{};const getDaytype=(output="en")=>(date.getDay()===0||shukujitsu.data?.find(row=>row[0]===strDate)?(output==="en"?"holiday":output==="ja"?"休日":2):date.getDay()===6?(output==="en"?"saturday":output==="ja"?"土曜":1):(output==="en"?"weekday":output==="ja"?"平日":0));const daytypeSelector={element:document.getElementById("daytype-selector"),list:["weekday","saturday","holiday",],get selected(){return this.list[this.element.selectedIndex];},set selected(daytype){this.element.selectedIndex=this.list.indexOf(daytype);},init(){this.element.onchange=()=>{displayTables(getNodeList(this.selected)?.data);};this.refreshOptions();},refreshOptions(){this.list.forEach((daytype,index)=>{const nodeList=getNodeList(daytype);this.element.children[index].textContent=["平日ダイヤ","土曜ダイヤ","休日ダイヤ",][index]+(nodeList?.update?` (${nodeList.update}更新)`:" (データなし)");});},};daytypeSelector.init();settingButton.onclick=()=>{const params=[{name:"乗り換えマージン：",type:"select",list:["-2分","-1分","なし","1分","2分",],value:settings.margin===0?"なし":settings.margin+"分",onchange(){settings.margin=(this.value==="なし"?0:Number(this.value.replace("分","")));localStorage.setItem("settings",JSON.stringify(settings));displayTables(getNodeList(daytypeSelector.selected)?.data);},},{name:"祝日データ更新：",type:"select",list:["毎回","毎日","毎月","オフ",],value:settings.update_shukujitsu,onchange(){settings.update_shukujitsu=this.value;localStorage.setItem("settings",JSON.stringify(settings));},},{name:"時刻表データ更新：",type:"select",list:["毎回","毎日","毎月","オフ",],value:settings.update_nodeList,onchange(){settings.update_nodeList=this.value;localStorage.setItem("settings",JSON.stringify(settings));},},];const modal=createModal();modal.style=`display:flex;flex-direction:column;align-items:stretch;`;modal.append((()=>{const div=document.createElement("div");div.style=`font-size:1.2em;font-weight:bold;text-align:center;`;div.textContent="設定";return div;})());params.forEach(param=>{modal.append((()=>{const div=document.createElement("div");div.style=`display:flex;justify-content:space-between;align-items:center;`;div.append((()=>{const span=document.createElement("span");span.textContent=param.name;return span;})());if(param.type==="select"){div.append((()=>{const select=document.createElement("select");select.append(...param.list.map(opt=>{const option=document.createElement("option");option.selected=opt===param.value;option.textContent=opt;return option;}));select.onchange=param.onchange;return select;})());}return div;})());});modal.append((()=>{const div=document.createElement("div");div.style=`margin-top:1em;border-radius:5px;color:red;text-align:center;`;div.classList.add("button");div.textContent="キャッシュクリア";div.onclick=()=>{if(confirm("localStorage内の全てのデータを消去します。よろしいですか？")){localStorage.clear();modal.close();}};return div;})());};daytypeSelector.selected=getDaytype();displayTables(getNodeList(getDaytype())?.data);const GAS_API_URL="https://script.google.com/macros/s/AKfycbwafFs2y7IvfL2OkU_-Z7PfQJGwfYjxxptibbApEtGJjL5BFDPVqAUhKxvXUJ7stle_mw/exec";const changes=[];const update_shukujitsu=(!shukujitsu.update||settings.update_shukujitsu==="毎回"?true:settings.update_shukujitsu==="毎日"?shukujitsu.update!==strDate:settings.update_shukujitsu==="毎月"?shukujitsu.update.replace(/\/\d+$/,"")!==strDate.replace(/\/\d+$/,""):false);if(update_shukujitsu){toast.classList.remove("hidden");toast.textContent="祝日データ取得中...";const shukujitsu_fetched=await(await fetch(GAS_API_URL+"?type=shukujitsu"+"&hash="+(shukujitsu.hash||""))).json();if(shukujitsu_fetched){Object.assign(shukujitsu,shukujitsu_fetched);changes.push("祝日データ");}shukujitsu.update=strDate;localStorage.setItem("shukujitsu",JSON.stringify(shukujitsu));}const nodeList=getNodeList(getDaytype())||{};const update_nodeList=(!nodeList.update||settings.update_nodeList==="毎回"?true:settings.update_nodeList==="毎日"?nodeList.update!==strDate:settings.update_nodeList==="毎月"?nodeList.update.replace(/\/\d+$/,"")!==strDate.replace(/\/\d+$/,""):false);if(update_nodeList){toast.classList.remove("hidden");toast.textContent=`時刻表データ(${getDaytype("ja")})取得中...`;const nodeList_fetched=await(await fetch(GAS_API_URL+"?type=nodeList"+"&hash="+(nodeList.hash||""))).json();if(nodeList_fetched){nodeList_fetched.update=strDate;localStorage.setItem("nodeList_"+getDaytype(),JSON.stringify(nodeList_fetched));changes.push(`時刻表データ(${getDaytype("ja")})`);}else{nodeList.update=strDate;localStorage.setItem("nodeList_"+getDaytype(),JSON.stringify(nodeList));}}if(update_shukujitsu||update_nodeList){setInterval(()=>toast.classList.add("hidden"),3000);if(changes.length){toast.textContent=`更新完了 (変更：${changes.join(", ")})`;daytypeSelector.refreshOptions();daytypeSelector.selected=getDaytype();displayTables(getNodeList(getDaytype())?.data);}else toast.textContent="更新完了 (変更なし)";}};</script></body></html>