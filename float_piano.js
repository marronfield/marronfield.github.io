export default()=>{const keyNameList=["C",["C#","Db"],"D",["D#","Eb"],"E","F",["F#","Gb"],"G",["G#","Ab"],"A",["A#","Bb"],"B"];const relativeKeyNameList=["Ⅰ","Ⅱb","Ⅱ","Ⅲb","Ⅲ","Ⅳ","Ⅳ#","Ⅴ","Ⅵb","Ⅵ","Ⅶb","Ⅶ"];const elems=Array.from(document.querySelectorAll("span.chord")).filter(elem=>elem.innerHTML.match(/^[^N]*[A-G][#b]?m?/));const originals=elems.map(elem=>elem.innerHTML);if(!document.getElementById("piano")){const[piano,keys]=createPiano();piano.id="piano";document.body.append(piano);setKeySelector(keys);setChordDisplay(keys);setSwipe(piano);document.querySelector("p.key")?.onclick();}else alert("2つ以上は無理です。");function changeTonicTo(tonicIndex){elems.forEach((elem,index)=>{elem.innerHTML=originals[index].replace(/[A-G][#b]?/g,match=>{const keyIndex=keyNameList.findIndex(name=>typeof name==="string"?name===match:name.includes(match));return relativeKeyNameList[(keyIndex-tonicIndex+12)%12];});elem.style.color="green";});}function resetToOriginal(){elems.forEach((elem,index)=>{elem.innerHTML=originals[index];elem.style.color="";});}function createPiano(defaultSelectedIndex=-1){const piano=document.createElement("div");const keys=new Array(12);let selectedIndex=-1;piano.style=`position:fixed;right:0px;bottom:0px;width:24em;height:9em;max-width:80vmin;max-height:30vmin;box-shadow:0 0 6px#777;display:flex;`;const rootIcon=document.createElement("div");rootIcon.style=`margin:5px 0;align-self:end;font-family:sans-serif;pointer-events:none;user-select:none;`;rootIcon.textContent="R";[0,2,4,5,7,9,11].forEach((keyIndex,index)=>{const key=document.createElement("div");key.style=`box-sizing:border-box;position:relative;width:0;flex-grow:1;${index===0?"":"border-left:1px solid#333;"}background:white;display:flex;justify-content:center;`;key.down=isRoot=>{key.style.background="#999";if(isRoot)key.appendChild(rootIcon);};key.up=()=>{key.style.background="white";if(key.contains(rootIcon))key.removeChild(rootIcon);};keys[keyIndex]=key;});[1,3,6,8,10].forEach((keyIndex,index)=>{const key=document.createElement("div");const pos=(W,w,i,n)=>{const gap=(W-n*w)/(n+1);return gap+(w+gap)*i;};const width=100/12;const left=index<2?pos(100/7*3,width,index,2):100/7*3+pos(100/7*4,width,index-2,3);key.style=`box-sizing:border-box;position:absolute;left:${left}%;width:${width}%;height:calc(100%*0.65);z-index:1;box-shadow:0 0 6px#777;background:#333;display:flex;justify-content:center;`;key.down=isRoot=>{key.style.background="#999";if(isRoot)key.appendChild(rootIcon);};key.up=()=>{key.style.background="#333";if(key.contains(rootIcon))key.removeChild(rootIcon);};keys[keyIndex]=key;});keys.forEach((key,index)=>{key.onclick=()=>{if(selectedIndex!==-1)keys[selectedIndex].style.borderBottom="none";if(selectedIndex!==index){key.style.borderBottom="5px solid green";changeTonicTo(index);selectedIndex=index;}else{selectedIndex=-1;resetToOriginal();}};if(index===defaultSelectedIndex)key.onclick();piano.appendChild(key);});return[piano,keys];}function setKeySelector(keys){const minorKeyNameList=keyNameList.map(name=>typeof name==="string"?name+"m":name.map(n=>n+"m"));const allKeyNameList=keyNameList.map((name,index)=>[name,minorKeyNameList[(index+9)%12]].flat());document.querySelectorAll("p.key").forEach(elem=>{const match=elem.innerHTML.match(/[A-G][#b]?m?/)[0];const tonicIndex=allKeyNameList.findIndex(name=>typeof name==="string"?name===match:name.includes(match));if(tonicIndex!==-1){elem.style.cursor="pointer";elem.onclick=keys[tonicIndex].onclick;}});}function setChordDisplay(keys){const chordTemplate={"":[0,4,7],"m":[0,3,7],"7":[0,4,7,10],"M7":[0,4,7,11],"m7":[0,3,7,10],"mM7":[0,3,7,11],"6":[0,4,7,9],"m6":[0,3,7,9],"aug":[0,4,8],"dim":[0,3,6],"dim7":[0,3,6,9],"add9":[0,2,4,7],"sus2":[0,2,7],"sus4":[0,5,7],"m7-5":[0,3,6,10],"9":[0,2,4,7,10],"M9":[0,2,4,7,11],"m9":[0,2,3,7,10],"mM9":[0,2,3,7,11],"69":[0,2,4,7,9]};elems.forEach((elem,index)=>{elem.onclick=()=>{keys.forEach(key=>key.up());const match=originals[index].match(new RegExp(`^\\(?([A-G][#b]?)?([^()/]*)(?:\\(([+\\-#b]?\\d+)\\))?(?:\\/([A-G][#b]?))?\\)?$`));if(!match)return;const[,root,quality,tension,root2]=match;const rootIndex=keyNameList.findIndex(name=>typeof name==="string"?name===root:name.includes(root));const root2Index=keyNameList.findIndex(name=>typeof name==="string"?name===root2:name.includes(root2));const tensionIndex=!tension?-1:tension.match(/-9|b9/)?1:tension.match(/9/)?2:tension.match(/\+9|#9/)?3:tension.match(/11/)?5:tension.match(/\+11|#11/)?6:tension.match(/-13|b13/)?8:tension.match(/13/)?9:-1;if(rootIndex!==-1&&quality in chordTemplate){let indexList=[...chordTemplate[quality]];if(tensionIndex!==-1&&!indexList.includes(tensionIndex))indexList.push(tensionIndex);indexList=indexList.map(index=>(index+rootIndex)%12);if(root2Index!==-1&&!indexList.includes(root2Index))indexList.push(root2Index);console.log(match,indexList);indexList.forEach(index=>{const isRoot=root2Index!==-1?index===root2Index:index===rootIndex;keys[index].down(isRoot);});}else if(root2Index!==-1){keys[root2Index].down(true);}else alert("知らないコードです。");};});}function setSwipe(target){const fps=60;const isTouchDevice="ontouchstart"in window;const eName={};if(isTouchDevice){eName.start="touchstart";eName.move="touchmove";eName.end="touchend";eName.leave="touchcancel";}else{eName.start="mousedown";eName.move="mousemove";eName.end="mouseup";eName.leave="mouseleave";}let me;let x=target.getBoundingClientRect().left;let y=target.getBoundingClientRect().top;let x_old,y_old;let tID;target.style.position="fixed";target.style.transform=`translate(${x}px,${y}px)`;target.style.left="0";target.style.top="0";window.onresize=()=>{x=clamp(x,0,window.innerWidth-target.offsetWidth);y=clamp(y,0,window.innerHeight-target.offsetHeight);target.style.transform=`translate(${x}px,${y}px)`;console.log(x,y);};target.addEventListener(eName.start,e=>{window.addEventListener(eName.move,onmove,{passive:false});window.addEventListener(eName.end,onend);window.addEventListener(eName.leave,onend);me=isTouchDevice?e.changedTouches[0]:e;const offsetX=me.clientX-x;const offsetY=me.clientY-y;if(tID)clearInterval(tID);tID=setInterval(()=>{x_old=x;y_old=y;x=clamp(me.clientX-offsetX,0,window.innerWidth-target.offsetWidth);y=clamp(me.clientY-offsetY,0,window.innerHeight-target.offsetHeight);target.style.transform=`translate(${x}px,${y}px)`;},1000/fps);});function onmove(e){me=isTouchDevice?e.changedTouches[0]:e;e.preventDefault();}function onend(e){window.removeEventListener(eName.move,onmove);window.removeEventListener(eName.end,onend);window.removeEventListener(eName.leave,onend);let dx=x-x_old;let dy=y-y_old;if(tID)clearInterval(tID);if(dx!==0||dy!==0){tID=setInterval(()=>{let clampedX,clampedY;[x,clampedX]=clamp(x+dx,0,window.innerWidth-target.offsetWidth,true);[y,clampedY]=clamp(y+dy,0,window.innerHeight-target.offsetHeight,true);target.style.transform=`translate(${x}px,${y}px)`;dx*=clampedX?-0.98:0.98;dy*=clampedY?-0.98:0.98;if(Math.abs(dx)<0.1&&Math.abs(dy)<0.1)clearInterval(tID);},1000/fps);}}function clamp(pos,min,max,returnClamped=false){if(returnClamped)return pos<min?[min,true]:max<pos?[max,true]:[pos,false];else return pos<min?min:max<pos?max:pos;}}}
